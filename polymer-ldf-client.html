<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="polymer-jsonp.html"/>
<script src="./dependencies/jquery-2.1.0.js"></script>
<script src="./dependencies/ldf-client-browser.js"></script>
<script src="./dependencies/prefixes.js"></script>

<!--
Element providing solution to no problem in particular.

##### Example

    <polymer-ldf-client></polymer-ldf-client>

@element polymer-ldf-client
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://github.com/tomayac/polymer-ldf-client-
-->
<polymer-element name="polymer-ldf-client" attributes="startFragment query responseFormat auto">
<template>
  <link rel="stylesheet" href="global.css">
  <polymer-jsonp id="jsonp" url="{{wikipediaQuery}}"></polymer-jsonp>
  <template id="wikip" bind="{{wiki}}">
    <section>
      <div id="org-info" class="clearfix">
        <div class="pic">
            <img src="{{ thumbnail.source }}" width="150" height="150" />
        </div>
        <div class="data">
          <h1>{{title}}</h1>
          <h4><a href="{{url}}">{{url}}</a></h4>
          <div class="sep"></div>
          <div class="abstract">
            {{ abstract }}
            <small><a href="http://en.wikipedia.org/?curid={{pageid}}">Wikipedia</a></small>
          </div>
        </div>
      </div>
    </section>
  </template>
</template>
  <script>
    Polymer({

      _DEBUG: true,

      _results: false,

      getQuery: function () {
        rq = "SELECT DISTINCT ?org ?pid ?label ?url WHERE {" +
                "?org owl:sameAs <" + this.localURI + ">." +
                "?org dbpediaowl:wikiPageID ?pid ." +
                "OPTIONAL {" +
                  "?org rdfs:label ?label ." +
                "}" +
                "OPTIONAL {" +
                  "?org schema:url ?url ." +
                "}" +
               "}";
        return rq
      },

      localURI: '',

      ldfServer: '',

      startFragment: '',

      responseFormat: 'streaming',

      auto: false,

      wikipediaQuery: '',

      ldfData: null,

      url: '',

      ready: function() {
        ldf.Logger.setLevel('warning');
        this.executeQuery();
        this.addEventListener('polymer-response', this.wikipediaLoaded);
      },

      executeQuery: function() {
        var that = this;
        // if (!this.query) {
        //   this._DEBUG && console.log('No query given.');
        //   return;
        // }
        this.localURI = this.getAttribute("localURI");
        this.ldfServer = this.getAttribute("ldfServer");
        this.query = this.getQuery();

        //debugger
        if (!this.localURI) {
          this._DEBUG && console.log('No localURI given.');
          return;
        }

        if (!this.ldfServer) {
          this._DEBUG && console.log('No LDF server given.');
          return;
        }

        this.query = this.query.replace(/\|localURI\|/i, "<" + this.localURI + ">");;
        this.startFragment = this.ldfServer + "?subject=" + this.localURI;

        this._DEBUG && console.log('Query:\n' + this.query);
        this._DEBUG && console.log('Local URI:\n' + this.localURI);
        this._DEBUG && console.log('Response format:\n' + this.responseFormat);

        var config = { prefixes: prefixes, logger: this._logger };
        config.fragmentsClient = new ldf.FragmentsClient(this.startFragment, config);
        var results = new ldf.SparqlIterator(this.query, config);

        if (this.responseFormat === 'streaming') {
          // Partial response
          var data = '';
          results.on('data', function(chunk) {
            var pid = stripQuotes(chunk["?pid"]);
            that.url = stripQuotes(chunk["?url"]);
            that.wikipURL(pid);
            console.debug(that.wikipediaQuery);
            //call the query.
            if (! that.$.jsonp.loading) {
             that.$.jsonp.go();
           }
            chunk = JSON.stringify(chunk);
            data += chunk;
            that.fire('ldf-query-streaming-response-partial', {
              response: chunk
            });
          });
          //Complete response
          results.on('end', function() {
           that.fire('ldf-query-streaming-response-end', {response: data});
          });
        } else if (this.responseFormat === 'polling') {
          this._results = results;
          return this.showNext();
        }
      },

      wikipURL: function (pid) {
        var that = this;
        var jp = 'http://en.wikipedia.org/w/api.php?&action=query&prop=pageimages|extracts&format=json&pithumbsize=125&exlimit=1&exsentences=2&pageids=' + pid +"&callback=?";
        that.wikipediaQuery = jp;
      },

      wikipediaLoaded: function (e) {
        var data = e.detail.response.query.pages;
          var key = Object.keys(data)[0];
          var winfo = data[key];
          if (winfo !== undefined) {
            winfo['abstract'] = stripHTML(winfo.extract);
            winfo['url'] = this.url;
            delete winfo.extract;
            var t = this.$.wikip;
            t.model = { wiki: data[key] };
          };
      },

      go: function() {
        return this.executeQuery();
      },

      showNext: function() {
        var that = this;
        if (!that._results) {
          return;
        }
        (function _showNext() {
          var result = that._results.read();
          if (result === null) {
            that._results.once('readable', _showNext);
          } else {
            that.fire('ldf-query-polling-response', {
              response: JSON.stringify(result)
            });
          }
        })();
      },

      queryChanged: function() {
        if (this.auto) {
          return this.executeQuery();
        }
      },

      startFragmentChanged: function() {
        if (this.auto) {
          return this.executeQuery();
        }
      }



    });

    function stripHTML(dirtyString) {
        var container = document.createElement('div');
        container.innerHTML = dirtyString;
        return container.textContent || container.innerText;
    }

    function stripQuotes(raw) {
      return raw.replace(/\"/g, "");
    }

  </script>
</polymer-element>

